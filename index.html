<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—…ã®ã—ãŠã‚Š - Travel Planner</title>
  <meta name="description" content="æ—…è¡Œã®äºˆå®šã‚’ç°¡å˜ã«ç®¡ç†ã§ãã‚‹ã‚¢ãƒ—ãƒªã€‚Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã©ã®ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã€‚">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <!-- Firebase Storage SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <!-- SheetJS (Excelå‡ºåŠ›ç”¨) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    @media print {
      .no-print { display: none; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // âš ï¸ Firebaseè¨­å®šï¼ˆFirebase Consoleã§å–å¾—ã—ã¦ãã ã•ã„ï¼‰
    // è©³ã—ã„æ‰‹é †ã¯ FIREBASE_SETUP.md ã‚’å‚ç…§
    // https://console.firebase.google.com/
    const firebaseConfig = {
      apiKey: "AIzaSyAg9IVqc9hTTXdLCIjbU21gEqIFYrCzuXA",
      authDomain: "travel-planner-af8bd.firebaseapp.com",
      projectId: "travel-planner-af8bd",
      storageBucket: "travel-planner-af8bd.firebasestorage.app",
      messagingSenderId: "914257292518",
      appId: "1:914257292518:web:01890d8a23e3386a931f27"
    };

    // FirebaseåˆæœŸåŒ–
    try {
      firebase.initializeApp(firebaseConfig);
      window.auth = firebase.auth();
      window.db = firebase.firestore();
      window.storage = firebase.storage();
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase initialization error:', error);
      alert('Firebaseè¨­å®šã‚¨ãƒ©ãƒ¼: firebaseConfigã‚’æ­£ã—ãè¨­å®šã—ã¦ãã ã•ã„');
    }

    // Claude API ã‚­ãƒ¼ï¼ˆAIè‡ªå‹•å…¥åŠ›æ©Ÿèƒ½ã«å¿…è¦ï¼‰
    // https://console.anthropic.com/ ã§å–å¾—ã—ã¦ãã ã•ã„
    window.CLAUDE_API_KEY = localStorage.getItem('claude_api_key') || '';
  </script>

  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    const Calendar = (props) => (
      <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );
    const Plane = (props) => (
      <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"></path>
      </svg>
    );
    const Train = (props) => (
      <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="4" y="4" width="16" height="16" rx="2"></rect>
        <path d="M4 11h16"></path>
        <path d="M12 4v7"></path>
        <path d="m8 20-2 2"></path>
        <path d="m16 20 2 2"></path>
      </svg>
    );
    const Hotel = (props) => (
      <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M3 21h18"></path>
        <path d="M9 8h1"></path>
        <path d="M9 12h1"></path>
        <path d="M9 16h1"></path>
        <path d="M14 8h1"></path>
        <path d="M14 12h1"></path>
        <path d="M14 16h1"></path>
        <path d="M5 21V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16"></path>
      </svg>
    );
    const Plus = (props) => (
      <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );
    const X = (props) => (
      <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );
    const ChevronRight = (props) => (
      <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    );
    const ChevronLeft = (props) => (
      <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    );
    const MapPin = (props) => (
      <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
        <circle cx="12" cy="10" r="3"></circle>
      </svg>
    );
    const Edit = (props) => (
      <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
    );
    const GripVertical = (props) => (
      <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="9" cy="12" r="1"></circle>
        <circle cx="9" cy="5" r="1"></circle>
        <circle cx="9" cy="19" r="1"></circle>
        <circle cx="15" cy="12" r="1"></circle>
        <circle cx="15" cy="5" r="1"></circle>
        <circle cx="15" cy="19" r="1"></circle>
      </svg>
    );
    const LogOut = (props) => (
      <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
    );

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒ»èªè¨¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const unsubscribe = window.auth.onAuthStateChanged((user) => {
          setUser(user);
          setLoading(false);
        });
        return unsubscribe;
      }, []);

      const signInWithGoogle = async () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          await window.auth.signInWithPopup(provider);
        } catch (error) {
          console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
          alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        }
      };

      const signOut = async () => {
        try {
          await window.auth.signOut();
        } catch (error) {
          console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        }
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div className="text-center">
              <div className="text-4xl mb-4">âœˆï¸</div>
              <div className="text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
          </div>
        );
      }

      if (!user) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
              <div className="text-6xl mb-6">âœˆï¸</div>
              <h1 className="text-3xl font-bold text-gray-800 mb-4">æ—…ã®ã—ãŠã‚Š</h1>
              <p className="text-gray-600 mb-8">
                Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦<br />
                ã©ã®ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã§ã‚‚æ—…è¡Œã‚’ç®¡ç†
              </p>
              <button
                onClick={signInWithGoogle}
                className="w-full bg-white border-2 border-gray-300 text-gray-700 rounded-lg py-3 px-4 font-semibold hover:bg-gray-50 transition flex items-center justify-center gap-3"
              >
                <svg className="w-6 h-6" viewBox="0 0 24 24">
                  <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Googleã§ãƒ­ã‚°ã‚¤ãƒ³
              </button>
              <p className="text-xs text-gray-500 mt-6">
                ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã§ã€åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã•ã‚Œã¾ã™
              </p>
            </div>
          </div>
        );
      }

      return <TravelApp user={user} onSignOut={signOut} />;
    }

    function TravelApp({ user, onSignOut }) {
      const [travels, setTravels] = useState([]);
      const [selectedTravel, setSelectedTravel] = useState(null);
      const [showAddTravel, setShowAddTravel] = useState(false);
      const [editingTravel, setEditingTravel] = useState(null);
      const [loading, setLoading] = useState(true);
      const [draggedTravelIndex, setDraggedTravelIndex] = useState(null);
      const [travelOrder, setTravelOrder] = useState([]);

      useEffect(() => {
        if (!user) return;
        const unsubscribe = window.db
          .collection('users').doc(user.uid).collection('travels')
          .onSnapshot((snapshot) => {
            const travelsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setTravels(travelsData);
            setLoading(false);
          }, (error) => { console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error); setLoading(false); });
        return unsubscribe;
      }, [user]);

      // è¡¨ç¤ºé †ï¼šorderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å„ªå…ˆã€ãªã‘ã‚Œã°é–‹å§‹æ—¥é †
      const sortedTravels = [...travels].sort((a, b) => {
        if (a.order !== undefined && b.order !== undefined) return a.order - b.order;
        return new Date(a.startDate) - new Date(b.startDate);
      });

      const addTravel = async (travel) => {
        try {
          await window.db.collection('users').doc(user.uid).collection('travels').add({
            ...travel, items: [], order: travels.length,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          setShowAddTravel(false);
        } catch (error) { console.error('è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error); alert('æ—…è¡Œã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      };

      const updateTravel = async (updatedTravel) => {
        try {
          const { id, ...data } = updatedTravel;
          await window.db.collection('users').doc(user.uid).collection('travels').doc(id).update(data);
          setSelectedTravel(updatedTravel);
        } catch (error) { console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error); alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      };

      const editTravel = async (travel) => {
        try {
          const { id, ...data } = travel;
          await window.db.collection('users').doc(user.uid).collection('travels').doc(id).update(data);
          setEditingTravel(null);
        } catch (error) { console.error('ç·¨é›†ã‚¨ãƒ©ãƒ¼:', error); alert('ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      };

      const duplicateTravel = async (travel) => {
        try {
          const { id, createdAt, ...data } = travel;
          await window.db.collection('users').doc(user.uid).collection('travels').add({
            ...data, name: `${data.name}ï¼ˆã‚³ãƒ”ãƒ¼ï¼‰`, order: travels.length,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch (error) { console.error('è¤‡è£½ã‚¨ãƒ©ãƒ¼:', error); alert('è¤‡è£½ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      };

      const deleteTravel = async (id) => {
        if (confirm('ã“ã®æ—…è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          try {
            await window.db.collection('users').doc(user.uid).collection('travels').doc(id).delete();
          } catch (error) { console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error); alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
        }
      };

      // æ—…è¡Œã®ãƒ‰ãƒ©ãƒƒã‚°ä¸¦ã³æ›¿ãˆ
      const handleTravelDragStart = (index) => setDraggedTravelIndex(index);

      const handleTravelDragOver = (e, index) => {
        e.preventDefault();
        if (draggedTravelIndex === null || draggedTravelIndex === index) return;
        const newSorted = [...sortedTravels];
        const dragged = newSorted[draggedTravelIndex];
        newSorted.splice(draggedTravelIndex, 1);
        newSorted.splice(index, 0, dragged);
        // ãƒ­ãƒ¼ã‚«ãƒ«å³æ™‚åæ˜ ç”¨ã«orderã‚’æ›´æ–°
        newSorted.forEach((t, i) => { t._tempOrder = i; });
        setDraggedTravelIndex(index);
        setTravels(prev => prev.map(t => {
          const found = newSorted.find(n => n.id === t.id);
          return found ? { ...t, order: found._tempOrder } : t;
        }));
      };

      const handleTravelDragEnd = async () => {
        setDraggedTravelIndex(null);
        // Firestoreã«é †åºã‚’ä¿å­˜
        const batch = window.db.batch();
        sortedTravels.forEach((t, i) => {
          const ref = window.db.collection('users').doc(user.uid).collection('travels').doc(t.id);
          batch.update(ref, { order: i });
        });
        try { await batch.commit(); } catch (e) { console.error('é †åºä¿å­˜ã‚¨ãƒ©ãƒ¼:', e); }
      };

      if (selectedTravel) {
        return (
          <TravelDetail 
            travel={selectedTravel} user={user}
            onBack={() => setSelectedTravel(null)}
            onUpdate={updateTravel} onSignOut={onSignOut}
          />
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
          <div className="max-w-2xl mx-auto p-4">
            <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h1 className="text-3xl font-bold text-gray-800 mb-2">âœˆï¸ æ—…ã®ã—ãŠã‚Š</h1>
                  <p className="text-gray-600">æ—…è¡Œã‚’æ•´ç†ã—ã¦ã€å¿«é©ãªæ—…ã‚’</p>
                </div>
                <div className="flex items-center gap-3">
                  <img src={user.photoURL || 'https://via.placeholder.com/40'} alt={user.displayName || 'User'} className="w-10 h-10 rounded-full" />
                  <button onClick={onSignOut} className="text-gray-500 hover:text-gray-700 transition" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">
                    <LogOut size={20} />
                  </button>
                </div>
              </div>
            </div>

            <button
              onClick={() => setShowAddTravel(true)}
              className="w-full bg-indigo-600 text-white rounded-xl py-4 mb-6 font-semibold shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2"
            >
              <Plus size={24} />æ–°ã—ã„æ—…è¡Œã‚’è¿½åŠ 
            </button>

            {loading ? (
              <div className="bg-white rounded-xl p-8 text-center text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</div>
            ) : (
              <div className="space-y-4">
                {sortedTravels.length === 0 ? (
                  <div className="bg-white rounded-xl p-8 text-center text-gray-500">
                    æ—…è¡ŒãŒã¾ã ã‚ã‚Šã¾ã›ã‚“<br />ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„
                  </div>
                ) : (
                  sortedTravels.map((travel, index) => (
                    <TravelCard 
                      key={travel.id} travel={travel} index={index}
                      onClick={() => setSelectedTravel(travel)}
                      onEdit={() => setEditingTravel(travel)}
                      onDuplicate={() => duplicateTravel(travel)}
                      onDelete={deleteTravel}
                      onDragStart={handleTravelDragStart}
                      onDragOver={handleTravelDragOver}
                      onDragEnd={handleTravelDragEnd}
                    />
                  ))
                )}
              </div>
            )}

            {showAddTravel && (
              <TravelModal onClose={() => setShowAddTravel(false)} onSave={addTravel} />
            )}
            {editingTravel && (
              <TravelModal travel={editingTravel} onClose={() => setEditingTravel(null)} onSave={editTravel} />
            )}
          </div>
        </div>
      );
    }

    function TravelCard({ travel, index, onClick, onEdit, onDuplicate, onDelete, onDragStart, onDragOver, onDragEnd }) {
      const [showMenu, setShowMenu] = useState(false);

      const formatDateRange = (start, end) => {
        const startDate = new Date(start);
        const endDate = new Date(end);
        return `${startDate.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric' })} - ${endDate.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric' })}`;
      };

      const totalAmount = (travel.items || []).reduce((sum, item) => sum + (Number(item.amount) || 0), 0);

      return (
        <div
          draggable
          onDragStart={() => onDragStart(index)}
          onDragOver={(e) => onDragOver(e, index)}
          onDragEnd={onDragEnd}
          className="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition"
        >
          <div className="p-5">
            <div className="flex items-start gap-3">
              <div className="text-gray-300 cursor-grab mt-1">
                <GripVertical size={20} />
              </div>
              <div className="flex-1 cursor-pointer" onClick={onClick}>
                <div className="flex items-start justify-between mb-3">
                  <div>
                    <h3 className="font-bold text-xl text-gray-800 mb-1">{travel.name}</h3>
                    <div className="text-sm text-gray-600">ğŸ“ {travel.destination}</div>
                  </div>
                  <div className="relative" onClick={e => e.stopPropagation()}>
                    <button
                      onClick={() => setShowMenu(!showMenu)}
                      className="text-gray-400 hover:text-gray-600 p-1"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle>
                      </svg>
                    </button>
                    {showMenu && (
                      <div className="absolute right-0 top-8 bg-white rounded-xl shadow-xl border border-gray-100 z-10 w-40 py-1">
                        <button onClick={() => { onEdit(); setShowMenu(false); }} className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                          <Edit size={14} /> ç·¨é›†
                        </button>
                        <button onClick={() => { onDuplicate(); setShowMenu(false); }} className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                          è¤‡è£½
                        </button>
                        <hr className="my-1" />
                        <button onClick={() => { onDelete(travel.id); setShowMenu(false); }} className="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2">
                          <X size={14} /> å‰Šé™¤
                        </button>
                      </div>
                    )}
                  </div>
                </div>
                <div className="flex items-center gap-2 text-sm text-gray-600">
                  <Calendar size={16} />
                  {formatDateRange(travel.startDate, travel.endDate)}
                </div>
                <div className="mt-3 flex items-center justify-between">
                  <div className="text-sm text-gray-500">{travel.items?.length || 0}ä»¶ã®äºˆå®š</div>
                  {totalAmount > 0 && (
                    <div className="text-sm font-semibold text-indigo-600">åˆè¨ˆ Â¥{totalAmount.toLocaleString()}</div>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function TravelModal({ travel = null, onClose, onSave }) {
      const [formData, setFormData] = useState(travel || { name: '', destination: '', startDate: '', endDate: '' });

      const handleSubmit = (e) => {
        e.preventDefault();
        if (!formData.name || !formData.destination || !formData.startDate || !formData.endDate) {
          alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return;
        }
        onSave(formData);
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl max-w-lg w-full">
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold text-gray-800">{travel ? 'æ—…è¡Œã‚’ç·¨é›†' : 'æ–°ã—ã„æ—…è¡Œ'}</h2>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={24} /></button>
              </div>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">æ—…è¡Œå *</label>
                  <input type="text" value={formData.name}
                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="ä¾‹: æ±äº¬å‡ºå¼µã€æœ­å¹Œæ—…è¡Œ" />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">è¡Œãå…ˆ *</label>
                  <input type="text" value={formData.destination}
                    onChange={(e) => setFormData({ ...formData, destination: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="ä¾‹: æ±äº¬ã€æœ­å¹Œ" />
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">é–‹å§‹æ—¥ *</label>
                    <input type="date" value={formData.startDate}
                      onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">çµ‚äº†æ—¥ *</label>
                    <input type="date" value={formData.endDate}
                      onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                  </div>
                </div>
                <button type="submit" className="w-full bg-indigo-600 text-white rounded-lg py-3 font-semibold hover:bg-indigo-700 transition">
                  {travel ? 'ä¿å­˜' : 'è¿½åŠ '}
                </button>
              </form>
            </div>
          </div>
        </div>
      );
    }

    function TravelDetail({ travel, onBack, onUpdate }) {
      const [items, setItems] = useState(travel.items || []);
      const [showAddItem, setShowAddItem] = useState(false);
      const [editingItem, setEditingItem] = useState(null);
      const [selectedQR, setSelectedQR] = useState(null);
      const [draggedIndex, setDraggedIndex] = useState(null);
      const [showAIImport, setShowAIImport] = useState(false);

      useEffect(() => {
        setItems(travel.items || []);
      }, [travel]);

      const saveItems = (newItems) => {
        setItems(newItems);
        onUpdate({ ...travel, items: newItems });
      };

      const addItem = (item) => {
        const newItems = [...items, { ...item, id: Date.now() }];
        saveItems(newItems);
        setShowAddItem(false);
      };

      const updateItem = (updatedItem) => {
        const newItems = items.map(item => 
          item.id === updatedItem.id ? updatedItem : item
        );
        saveItems(newItems);
        setEditingItem(null);
      };

      const deleteItem = (id) => {
        if (confirm('ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          saveItems(items.filter(item => item.id !== id));
        }
      };

      const duplicateItem = (item) => {
        const { id, ...rest } = item;
        const newItem = { ...rest, id: Date.now(), title: `${item.title}ï¼ˆã‚³ãƒ”ãƒ¼ï¼‰` };
        const newItems = [...items, newItem];
        saveItems(newItems);
      };

      const handleDragStart = (index) => {
        setDraggedIndex(index);
      };

      const handleDragOver = (e, index) => {
        e.preventDefault();
        if (draggedIndex === null || draggedIndex === index) return;

        const newItems = [...items];
        const draggedItem = newItems[draggedIndex];
        newItems.splice(draggedIndex, 1);
        newItems.splice(index, 0, draggedItem);
        
        setItems(newItems);
        setDraggedIndex(index);
      };

      const handleDragEnd = () => {
        saveItems(items);
        setDraggedIndex(null);
      };

      // Excelå‡ºåŠ›æ©Ÿèƒ½
      const downloadExcel = () => {
        const typeLabel = { flight: 'é£›è¡Œæ©Ÿ', train: 'é›»è»Š', hotel: 'ãƒ›ãƒ†ãƒ«', other: 'ãã®ä»–' };
        const statusLabel = {
          flight: { undecided: 'æœªå®š', reserved_unpaid: 'äºˆç´„ï¼ˆæœªè³¼å…¥ï¼‰', reserved_paid: 'äºˆç´„ï¼ˆè³¼å…¥æ¸ˆï¼‰' },
          train: { undecided: 'æœªå®š', walk_in: 'é£›ã³ä¹—ã‚Š', reserved: 'äºˆç´„æ¸ˆ' },
          hotel: { undecided: 'æœªå®š', reserved: 'äºˆç´„æ¸ˆ' },
          other: { undecided: 'æœªå®š', reserved: 'äºˆç´„æ¸ˆ' }
        };

        const wb = XLSX.utils.book_new();

        // ===== æ—…è²»æ˜ç´°ã‚·ãƒ¼ãƒˆ =====
        const wsData = [];
        wsData.push(['æ—…è¡Œå', travel.name]);
        wsData.push(['è¡Œãå…ˆ', travel.destination]);
        wsData.push(['æœŸé–“', travel.startDate + ' ã€œ ' + travel.endDate]);
        wsData.push([]);
        wsData.push(['ç¨®é¡', 'ã‚¿ã‚¤ãƒˆãƒ«', 'æ—¥æ™‚', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'é‡‘é¡ï¼ˆå††ï¼‰', 'è©³ç´°', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æœŸæ—¥', 'ãƒ¡ãƒ¢']);

        items.forEach(item => {
          const status = item.status ? (statusLabel[item.type]?.[item.status] || item.status) : '';
          let detail = '';
          if (item.type === 'flight') detail = [item.airline, item.flightNumber, item.flightTimeStart && item.flightTimeEnd ? item.flightTimeStart + 'ã€œ' + item.flightTimeEnd : ''].filter(Boolean).join(' ');
          if (item.type === 'train') detail = [item.trainLine, item.trainDestination, item.trainPlatform].filter(Boolean).join(' ');
          if (item.type === 'hotel') detail = item.address || '';
          if (item.type === 'other') detail = item.destination || '';

          wsData.push([
            typeLabel[item.type] || item.type,
            item.title,
            item.datetime ? new Date(item.datetime).toLocaleString('ja-JP') : '',
            status,
            item.amount ? Number(item.amount) : '',
            detail,
            item.cancelDeadline ? new Date(item.cancelDeadline).toLocaleString('ja-JP') : '',
            item.notes || ''
          ]);
        });

        const total = items.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
        wsData.push([]);
        wsData.push(['åˆè¨ˆé‡‘é¡', '', '', '', total, '', '', '']);

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        ws['!cols'] = [
          { wch: 10 }, { wch: 28 }, { wch: 20 }, { wch: 16 },
          { wch: 12 }, { wch: 30 }, { wch: 20 }, { wch: 30 }
        ];
        XLSX.utils.book_append_sheet(wb, ws, 'æ—…è²»æ˜ç´°');

        // ===== ã‚µãƒãƒªãƒ¼ã‚·ãƒ¼ãƒˆ =====
        const summary = {};
        items.forEach(item => {
          const label = typeLabel[item.type] || item.type;
          if (!summary[label]) summary[label] = { count: 0, total: 0 };
          summary[label].count++;
          summary[label].total += Number(item.amount) || 0;
        });

        const wsSumData = [
          ['æ—…è¡Œå', travel.name],
          ['è¡Œãå…ˆ', travel.destination],
          [],
          ['ç¨®é¡', 'ä»¶æ•°', 'å°è¨ˆï¼ˆå††ï¼‰'],
          ...Object.entries(summary).map(([k, v]) => [k, v.count, v.total]),
          [],
          ['åˆè¨ˆ', items.length, total]
        ];
        const wsSum = XLSX.utils.aoa_to_sheet(wsSumData);
        wsSum['!cols'] = [{ wch: 12 }, { wch: 8 }, { wch: 14 }];
        XLSX.utils.book_append_sheet(wb, wsSum, 'ã‚µãƒãƒªãƒ¼');

        XLSX.writeFile(wb, travel.name + '_æ—…è²»æ˜ç´°.xlsx');
      };

      const totalAmount = items.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
          <div className="max-w-2xl mx-auto p-4">
            <button
              onClick={onBack}
              className="mb-4 flex items-center gap-2 text-indigo-600 hover:text-indigo-800 font-semibold no-print"
            >
              <ChevronLeft size={20} />
              æ—…è¡Œä¸€è¦§ã«æˆ»ã‚‹
            </button>

            <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
              <h1 className="text-3xl font-bold text-gray-800 mb-2">{travel.name}</h1>
              <div className="text-gray-600">ğŸ“ {travel.destination}</div>
              <div className="text-sm text-gray-500 mt-2">
                {new Date(travel.startDate).toLocaleDateString('ja-JP', { month: 'long', day: 'numeric' })} - 
                {new Date(travel.endDate).toLocaleDateString('ja-JP', { month: 'long', day: 'numeric' })}
              </div>
              {totalAmount > 0 && (
                <div className="mt-3 p-3 bg-indigo-50 rounded-xl">
                  <div className="text-sm text-indigo-600 font-semibold">ğŸ’° åˆè¨ˆæ—…è²»</div>
                  <div className="text-2xl font-bold text-indigo-700">Â¥{totalAmount.toLocaleString()}</div>
                </div>
              )}
            </div>

            <div className="flex gap-3 mb-6 no-print">
              <button
                onClick={() => setShowAddItem(true)}
                className="flex-1 bg-indigo-600 text-white rounded-xl py-4 font-semibold shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2"
              >
                <Plus size={24} />
                äºˆå®šã‚’è¿½åŠ 
              </button>
              <button
                onClick={() => setShowAIImport(true)}
                className="bg-purple-600 text-white rounded-xl px-4 py-4 font-semibold shadow-lg hover:bg-purple-700 transition flex items-center justify-center gap-2"
                title="AIã§è‡ªå‹•å…¥åŠ›"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M12 2a10 10 0 1 0 10 10"/><path d="M12 8v4l3 3"/><path d="M18 2l4 4-4 4"/><path d="M22 2l-4 4"/>
                </svg>
                AIå…¥åŠ›
              </button>
              <button
                onClick={downloadExcel}
                className="bg-green-600 text-white rounded-xl px-4 py-4 font-semibold shadow-lg hover:bg-green-700 transition flex items-center justify-center gap-2"
                title="Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Excel
              </button>
            </div>

            <div className="space-y-4">
              {items.length === 0 ? (
                <div className="bg-white rounded-xl p-8 text-center text-gray-500">
                  äºˆå®šãŒã¾ã ã‚ã‚Šã¾ã›ã‚“<br />
                  ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„
                </div>
              ) : (
                items.map((item, index) => (
                  <ItemCard
                    key={item.id}
                    item={item}
                    index={index}
                    onEdit={() => setEditingItem(item)}
                    onDuplicate={() => duplicateItem(item)}
                    onDelete={() => deleteItem(item.id)}
                    onQRClick={setSelectedQR}
                    onDragStart={handleDragStart}
                    onDragOver={handleDragOver}
                    onDragEnd={handleDragEnd}
                  />
                ))
              )}
            </div>

            {showAIImport && (
              <AIImportModal
                travel={travel}
                onClose={() => setShowAIImport(false)}
                onImport={(newItem) => { addItem(newItem); setShowAIImport(false); }}
              />
            )}

            {showAddItem && (
              <ItemModal
                travel={travel}
                onClose={() => setShowAddItem(false)}
                onSave={addItem}
              />
            )}

            {editingItem && (
              <ItemModal
                travel={travel}
                item={editingItem}
                onClose={() => setEditingItem(null)}
                onSave={updateItem}
              />
            )}

            {selectedQR && (
              <QRModal
                imageData={selectedQR}
                onClose={() => setSelectedQR(null)}
              />
            )}
          </div>
        </div>
      );
    }

    function ItemCard({ item, index, onEdit, onDuplicate, onDelete, onQRClick, onDragStart, onDragOver, onDragEnd }) {
      const getIcon = () => {
        switch(item.type) {
          case 'flight': return <Plane className="text-blue-600" size={24} />;
          case 'train': return <Train className="text-green-600" size={24} />;
          case 'hotel': return <Hotel className="text-purple-600" size={24} />;
          default: return <MapPin className="text-orange-600" size={24} />;
        }
      };

      const getTypeLabel = () => {
        switch(item.type) {
          case 'flight': return 'é£›è¡Œæ©Ÿ';
          case 'train': return 'é›»è»Š';
          case 'hotel': return 'ãƒ›ãƒ†ãƒ«';
          default: return 'ãã®ä»–';
        }
      };

      const getStatusLabel = () => {
        const statusMap = {
          flight: { undecided: 'æœªå®š', reserved_unpaid: 'äºˆç´„ï¼ˆæœªè³¼å…¥ï¼‰', reserved_paid: 'äºˆç´„ï¼ˆè³¼å…¥æ¸ˆï¼‰' },
          train: { undecided: 'æœªå®š', walk_in: 'é£›ã³ä¹—ã‚Š', reserved: 'äºˆç´„æ¸ˆ' },
          hotel: { undecided: 'æœªå®š', reserved: 'äºˆç´„æ¸ˆ' },
          other: { undecided: 'æœªå®š', reserved: 'äºˆç´„æ¸ˆ' }
        };
        return statusMap[item.type]?.[item.status] || null;
      };

      const getStatusColor = () => {
        if (!item.status || item.status === 'undecided') return 'bg-gray-100 text-gray-600';
        if (item.status === 'reserved_paid' || item.status === 'reserved') return 'bg-green-100 text-green-700';
        if (item.status === 'reserved_unpaid') return 'bg-yellow-100 text-yellow-700';
        if (item.status === 'walk_in') return 'bg-blue-100 text-blue-700';
        return 'bg-gray-100 text-gray-600';
      };

      const formatDateTime = (datetime) => {
        const date = new Date(datetime);
        return date.toLocaleString('ja-JP', {
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      };

      const statusLabel = getStatusLabel();

      return (
        <div
          draggable
          onDragStart={() => onDragStart(index)}
          onDragOver={(e) => onDragOver(e, index)}
          onDragEnd={onDragEnd}
          className="bg-white rounded-xl shadow-md overflow-hidden cursor-move hover:shadow-lg transition"
        >
          <div className="p-5">
            <div className="flex items-start gap-3">
              <div className="text-gray-400 cursor-grab active:cursor-grabbing mt-1 no-print">
                <GripVertical size={20} />
              </div>
              <div className="flex-1">
                <div className="flex items-start justify-between mb-2">
                  <div className="flex items-center gap-3">
                    {getIcon()}
                    <div>
                      <div className="flex items-center gap-2 mb-1">
                        <div className="text-xs text-gray-500">{getTypeLabel()}</div>
                        {statusLabel && (
                          <span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${getStatusColor()}`}>
                            {statusLabel}
                          </span>
                        )}
                      </div>
                      <h3 className="font-bold text-lg text-gray-800">{item.title}</h3>
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    {item.amount > 0 && (
                      <div className="text-sm font-bold text-indigo-600">Â¥{Number(item.amount).toLocaleString()}</div>
                    )}
                    <div className="flex gap-2 no-print">
                      <button onClick={onEdit} className="text-gray-400 hover:text-indigo-500 transition" title="ç·¨é›†">
                        <Edit size={18} />
                      </button>
                      <button onClick={onDuplicate} className="text-gray-400 hover:text-green-500 transition" title="è¤‡è£½">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                      </button>
                      <button onClick={onDelete} className="text-gray-400 hover:text-red-500 transition" title="å‰Šé™¤">
                        <X size={18} />
                      </button>
                    </div>
                  </div>
                </div>

                <div className="text-sm text-gray-600 mb-3">
                  <div className="flex items-center gap-2">
                    <Calendar size={16} />
                    å‡ºç™º: {formatDateTime(item.datetime)}
                  </div>
                </div>

                {item.type === 'flight' && (
                  <div className="space-y-2 text-sm">
                    {item.airline && (
                      <div className="text-gray-700">èˆªç©ºä¼šç¤¾: <span className="font-semibold">{item.airline}</span></div>
                    )}
                    {item.flightNumber && (
                      <div className="text-gray-700">ä¾¿å: <span className="font-semibold">{item.flightNumber}</span></div>
                    )}
                    {(item.flightTimeStart || item.flightTimeEnd) && (
                      <div className="text-gray-700">
                        â° {item.flightTimeStart || '--:--'}ï½{item.flightTimeEnd || '--:--'}
                      </div>
                    )}
                  </div>
                )}

                {item.type === 'train' && (
                  <div className="space-y-2 text-sm">
                    {(item.trainTimeStart || item.trainTimeEnd) && (
                      <div className="text-gray-700">
                        â° {item.trainTimeStart || '--:--'}ï½{item.trainTimeEnd || '--:--'}
                      </div>
                    )}
                    {item.trainLine && (
                      <div className="text-gray-700">ğŸšƒ {item.trainLine}</div>
                    )}
                    {item.trainDestination && (
                      <div className="text-gray-700">è¡Œãå…ˆ: {item.trainDestination}</div>
                    )}
                    {item.trainPlatform && (
                      <div className="text-gray-700">ä¹—ã‚Šå ´: <span className="font-semibold">{item.trainPlatform}</span></div>
                    )}
                  </div>
                )}

                {item.type === 'hotel' && (
                  <div className="space-y-2 text-sm">
                    {item.address && (
                      <div className="text-gray-700">ğŸ“ {item.address}</div>
                    )}
                    {item.checkOut && (
                      <div className="text-gray-700">
                        ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ: {new Date(item.checkOut).toLocaleString('ja-JP', {
                          month: 'long',
                          day: 'numeric',
                          hour: '2-digit',
                          minute: '2-digit'
                        })}
                      </div>
                    )}
                    {item.cancelDeadline && (() => {
                      const deadline = new Date(item.cancelDeadline);
                      const now = new Date();
                      const diffDays = (deadline - now) / (1000 * 60 * 60 * 24);
                      const isPast = diffDays < 0;
                      const isUrgent = diffDays >= 0 && diffDays <= 3;
                      return (
                        <div className={`flex items-center gap-1 font-semibold px-2 py-1 rounded-lg ${isPast ? 'bg-gray-100 text-gray-500' : isUrgent ? 'bg-red-100 text-red-700' : 'bg-yellow-50 text-yellow-700'}`}>
                          âš ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«æœŸæ—¥: {deadline.toLocaleString('ja-JP', { month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                          {isPast && <span className="text-xs ml-1">ï¼ˆæœŸé™åˆ‡ã‚Œï¼‰</span>}
                          {isUrgent && <span className="text-xs ml-1">ï¼ˆã‚ã¨{Math.max(0, Math.floor(diffDays))}æ—¥ï¼ï¼‰</span>}
                        </div>
                      );
                    })()}
                  </div>
                )}

                {item.type === 'other' && (
                  <div className="space-y-2 text-sm">
                    {item.destination && (
                      <div className="text-gray-700">ğŸ¯ {item.destination}</div>
                    )}
                    {item.otherAddress && (
                      <div className="text-gray-700">ğŸ“ {item.otherAddress}</div>
                    )}
                  </div>
                )}

                {item.notes && (
                  <div className="mt-3 p-3 bg-gray-50 rounded-lg text-sm text-gray-700">
                    {item.notes}
                  </div>
                )}

                {item.attachments && item.attachments.length > 0 && (
                  <div className="mt-3">
                    <div className="text-xs font-semibold text-gray-600 mb-2">ğŸ“ äºˆå®šæƒ…å ±</div>
                    <div className="space-y-2">
                      {item.attachments.map((file, index) => (
                        <a
                          key={index}
                          href={file.url || file.data}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="block p-2 bg-blue-50 text-blue-700 rounded text-sm hover:bg-blue-100 transition"
                        >
                          ğŸ“„ {file.name}
                        </a>
                      ))}
                    </div>
                  </div>
                )}

                {item.receipts && item.receipts.length > 0 && (
                  <div className="mt-3">
                    <div className="text-xs font-semibold text-gray-600 mb-2">ğŸ§¾ é ˜åæ›¸</div>
                    <div className="space-y-2">
                      {item.receipts.map((file, index) => (
                        <a
                          key={index}
                          href={file.url || file.data}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="block p-2 bg-green-50 text-green-700 rounded text-sm hover:bg-green-100 transition"
                        >
                          ğŸ§¾ {file.name}
                        </a>
                      ))}
                    </div>
                  </div>
                )}

                {item.qrCode && (
                  <button
                    onClick={() => onQRClick(item.qrCode)}
                    className="mt-3 w-full bg-indigo-50 text-indigo-700 rounded-lg py-3 font-semibold hover:bg-indigo-100 transition flex items-center justify-center gap-2 no-print"
                  >
                    QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                    <ChevronRight size={20} />
                  </button>
                )}

                {item.type === 'flight' && item.airline && (
                  <a
                    href={(() => {
                      switch(item.airline) {
                        case 'ANA': return 'https://www.ana.co.jp/fs/dom/jp/';
                        case 'JAL': return 'https://www.jal.co.jp/jp/ja/dom/flight-status/';
                        case 'ã‚½ãƒ©ã‚·ãƒ‰ã‚¨ã‚¢': return 'https://www.solaseedair.jp/flight_info/';
                        case 'ã‚¹ã‚«ã‚¤ãƒãƒ¼ã‚¯': return 'https://www.skymark.co.jp/ja/flight_info/';
                        case 'ã‚¸ã‚§ãƒƒãƒˆã‚¹ã‚¿ãƒ¼': return 'https://www.jetstar.com/jp/ja/flight-status';
                        case 'ãƒ”ãƒ¼ãƒ': return 'https://www.flypeach.com/jp/ja-jp/flightinfo';
                        default: return 'https://www.ana.co.jp/fs/dom/jp/';
                      }
                    })()}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="mt-2 block w-full bg-blue-50 text-blue-700 rounded-lg py-3 text-center font-semibold hover:bg-blue-100 transition no-print"
                  >
                    âœˆï¸ é‹èˆªçŠ¶æ³ã‚’ç¢ºèª
                  </a>
                )}

                {item.type === 'train' && (
                  <a
                    href="https://transit.yahoo.co.jp/"
                    target="_blank"
                    rel="noopener noreferrer"
                    className="mt-2 block w-full bg-red-50 text-red-700 rounded-lg py-3 text-center font-semibold hover:bg-red-100 transition no-print"
                  >
                    ğŸ” Yahoo!ä¹—ã‚Šæ›ãˆæ¡ˆå†…ã§æ¤œç´¢
                  </a>
                )}

                {item.type === 'hotel' && item.address && (
                  <>
                    <a
                      href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address)}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="mt-2 block w-full bg-green-50 text-green-700 rounded-lg py-3 text-center font-semibold hover:bg-green-100 transition no-print"
                    >
                      ğŸ—ºï¸ Googleãƒãƒƒãƒ—ã§è¦‹ã‚‹
                    </a>
                    <a
                      href={`https://www.jalan.net/uw/uwp0400/uww0401init.do?keyword=${encodeURIComponent(item.title)}&area=`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="mt-2 block w-full bg-orange-50 text-orange-700 rounded-lg py-3 text-center font-semibold hover:bg-orange-100 transition no-print"
                    >
                      ğŸ¨ ã˜ã‚ƒã‚‰ã‚“ã§æ¤œç´¢
                    </a>
                  </>
                )}

                {item.type === 'other' && (
                  <>
                    {item.customLink && (
                      <a
                        href={item.customLink}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="mt-2 block w-full bg-purple-50 text-purple-700 rounded-lg py-3 text-center font-semibold hover:bg-purple-100 transition no-print"
                      >
                        ğŸ”— ãƒªãƒ³ã‚¯ã‚’é–‹ã
                      </a>
                    )}
                    {item.otherAddress && (
                      <a
                        href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.otherAddress)}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="mt-2 block w-full bg-green-50 text-green-700 rounded-lg py-3 text-center font-semibold hover:bg-green-100 transition no-print"
                      >
                        ğŸ—ºï¸ Googleãƒãƒƒãƒ—ã§è¦‹ã‚‹
                      </a>
                    )}
                  </>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    function ItemModal({ travel, item = null, onClose, onSave }) {
      const [type, setType] = useState(item?.type || '');
      
      const getDefaultCheckOut = (datetime) => {
        const date = new Date(datetime || travel.startDate + 'T15:00');
        date.setDate(date.getDate() + 1);
        date.setHours(10, 0, 0, 0);
        return date.toISOString().slice(0, 16);
      };

      const [formData, setFormData] = useState(item || {
        title: '',
        datetime: travel.startDate + 'T09:00',
        status: 'undecided',
        amount: '',
        airline: '',
        flightNumber: '',
        flightTimeStart: '',
        flightTimeEnd: '',
        trainTimeStart: '',
        trainTimeEnd: '',
        trainLine: '',
        trainDestination: '',
        trainPlatform: '',
        address: '',
        checkOut: '',
        destination: '',
        otherAddress: '',
        customLink: '',
        notes: '',
        qrCode: null,
        attachments: [],
        receipts: []
      });

      // Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦URLã‚’è¿”ã™
      const uploadToStorage = async (file, path) => {
        const user = window.auth.currentUser;
        if (!user) throw new Error('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
        const ref = window.storage.ref(`users/${user.uid}/${path}/${Date.now()}_${file.name}`);
        await ref.put(file);
        return await ref.getDownloadURL();
      };

      const [uploading, setUploading] = useState(false);

      const handleImageUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setUploading(true);
        try {
          const url = await uploadToStorage(file, 'qrcodes');
          setFormData(prev => ({ ...prev, qrCode: url }));
        } catch (err) {
          console.error('QRã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', err);
          alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        setUploading(false);
      };

      const handleAttachmentsUpload = async (e) => {
        const files = Array.from(e.target.files);
        setUploading(true);
        try {
          const newFiles = await Promise.all(files.map(async file => {
            const url = await uploadToStorage(file, 'attachments');
            return { name: file.name, url, type: file.type };
          }));
          setFormData(prev => ({ ...prev, attachments: [...(prev.attachments || []), ...newFiles] }));
        } catch (err) {
          console.error('æ·»ä»˜ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', err);
          alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        setUploading(false);
      };

      const handleReceiptsUpload = async (e) => {
        const files = Array.from(e.target.files);
        setUploading(true);
        try {
          const newFiles = await Promise.all(files.map(async file => {
            const url = await uploadToStorage(file, 'receipts');
            return { name: file.name, url, type: file.type };
          }));
          setFormData(prev => ({ ...prev, receipts: [...(prev.receipts || []), ...newFiles] }));
        } catch (err) {
          console.error('é ˜åæ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', err);
          alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        setUploading(false);
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (uploading) { alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚å®Œäº†ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚'); return; }
        if (!type || !formData.title || !formData.datetime) {
          alert('ç¨®é¡ã€ã‚¿ã‚¤ãƒˆãƒ«ã€å‡ºç™ºæ™‚åˆ»ã¯å¿…é ˆã§ã™');
          return;
        }
        if (type === 'flight' && !formData.airline) {
          alert('èˆªç©ºä¼šç¤¾ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        onSave({ ...formData, type });
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold text-gray-800">
                  {item ? 'äºˆå®šã‚’ç·¨é›†' : 'äºˆå®šã‚’è¿½åŠ '}
                </h2>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                  <X size={24} />
                </button>
              </div>

              <form onSubmit={handleSubmit} className="space-y-4">
                {!type && !item ? (
                  <div className="grid grid-cols-2 gap-3">
                    <button
                      type="button"
                      onClick={() => setType('flight')}
                      className="p-6 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition flex flex-col items-center gap-2"
                    >
                      <Plane size={32} className="text-blue-600" />
                      <span className="font-semibold">é£›è¡Œæ©Ÿ</span>
                    </button>
                    <button
                      type="button"
                      onClick={() => setType('train')}
                      className="p-6 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:bg-green-50 transition flex flex-col items-center gap-2"
                    >
                      <Train size={32} className="text-green-600" />
                      <span className="font-semibold">é›»è»Š</span>
                    </button>
                    <button
                      type="button"
                      onClick={() => setType('hotel')}
                      className="p-6 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition flex flex-col items-center gap-2"
                    >
                      <Hotel size={32} className="text-purple-600" />
                      <span className="font-semibold">ãƒ›ãƒ†ãƒ«</span>
                    </button>
                    <button
                      type="button"
                      onClick={() => setType('other')}
                      className="p-6 border-2 border-gray-200 rounded-xl hover:border-orange-500 hover:bg-orange-50 transition flex flex-col items-center gap-2"
                    >
                      <MapPin size={32} className="text-orange-600" />
                      <span className="font-semibold">ãã®ä»–</span>
                    </button>
                  </div>
                ) : (
                  <>
                    {item && (
                      <button
                        type="button"
                        onClick={() => setType('')}
                        className="text-sm text-indigo-600 hover:text-indigo-800"
                      >
                        â† ç¨®é¡ã‚’å¤‰æ›´
                      </button>
                    )}

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">
                        ã‚¿ã‚¤ãƒˆãƒ« *
                      </label>
                      <input
                        type="text"
                        value={formData.title}
                        onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        placeholder="ä¾‹: ç¾½ç”°ç©ºæ¸¯ â†’ ç¦å²¡ç©ºæ¸¯"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">
                        å‡ºç™ºæ™‚åˆ» *
                      </label>
                      <input
                        type="datetime-local"
                        value={formData.datetime}
                        onChange={(e) => {
                          const newDatetime = e.target.value;
                          setFormData({ 
                            ...formData, 
                            datetime: newDatetime,
                            checkOut: type === 'hotel' && !item ? getDefaultCheckOut(newDatetime) : formData.checkOut
                          });
                        }}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">
                        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                      </label>
                      <select
                        value={formData.status || 'undecided'}
                        onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                      >
                        {type === 'flight' && <>
                          <option value="undecided">æœªå®š</option>
                          <option value="reserved_unpaid">äºˆç´„ï¼ˆæœªè³¼å…¥ï¼‰</option>
                          <option value="reserved_paid">äºˆç´„ï¼ˆè³¼å…¥æ¸ˆï¼‰</option>
                        </>}
                        {type === 'train' && <>
                          <option value="undecided">æœªå®š</option>
                          <option value="walk_in">é£›ã³ä¹—ã‚Š</option>
                          <option value="reserved">äºˆç´„æ¸ˆ</option>
                        </>}
                        {type === 'hotel' && <>
                          <option value="undecided">æœªå®š</option>
                          <option value="reserved">äºˆç´„æ¸ˆ</option>
                        </>}
                        {type === 'other' && <>
                          <option value="undecided">æœªå®š</option>
                          <option value="reserved">äºˆç´„æ¸ˆ</option>
                        </>}
                      </select>
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">
                        é‡‘é¡ï¼ˆå††ï¼‰
                      </label>
                      <input
                        type="number"
                        value={formData.amount}
                        onChange={(e) => setFormData({ ...formData, amount: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        placeholder="ä¾‹: 15000"
                        min="0"
                      />
                    </div>

                    {type === 'flight' && (
                      <>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            èˆªç©ºä¼šç¤¾ *
                          </label>
                          <select
                            value={formData.airline}
                            onChange={(e) => setFormData({ ...formData, airline: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                          >
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="ANA">ANAï¼ˆå…¨æ—¥ç©ºï¼‰</option>
                            <option value="JAL">JALï¼ˆæ—¥æœ¬èˆªç©ºï¼‰</option>
                            <option value="ã‚½ãƒ©ã‚·ãƒ‰ã‚¨ã‚¢">ã‚½ãƒ©ã‚·ãƒ‰ã‚¨ã‚¢</option>
                            <option value="ã‚¹ã‚«ã‚¤ãƒãƒ¼ã‚¯">ã‚¹ã‚«ã‚¤ãƒãƒ¼ã‚¯</option>
                            <option value="ã‚¸ã‚§ãƒƒãƒˆã‚¹ã‚¿ãƒ¼">ã‚¸ã‚§ãƒƒãƒˆã‚¹ã‚¿ãƒ¼</option>
                            <option value="ãƒ”ãƒ¼ãƒ">Peach</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            ä¾¿å
                          </label>
                          <input
                            type="text"
                            value={formData.flightNumber}
                            onChange={(e) => setFormData({ ...formData, flightNumber: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            placeholder="ä¾‹: NH123"
                          />
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              å‡ºç™ºæ™‚åˆ»
                            </label>
                            <input
                              type="time"
                              value={formData.flightTimeStart}
                              onChange={(e) => setFormData({ ...formData, flightTimeStart: e.target.value })}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              åˆ°ç€æ™‚åˆ»
                            </label>
                            <input
                              type="time"
                              value={formData.flightTimeEnd}
                              onChange={(e) => setFormData({ ...formData, flightTimeEnd: e.target.value })}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            />
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            æ­ä¹—åˆ¸QRã‚³ãƒ¼ãƒ‰
                          </label>
                          <input
                            type="file"
                            accept="image/*"
                            onChange={handleImageUpload}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                          />
                          {formData.qrCode && (
                            <img src={formData.qrCode} alt="QR Preview" className="mt-2 w-32 h-32 object-contain border rounded" />
                          )}
                        </div>
                      </>
                    )}

                    {type === 'train' && (
                      <>
                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              ä¹—è»Šæ™‚åˆ»
                            </label>
                            <input
                              type="time"
                              value={formData.trainTimeStart}
                              onChange={(e) => setFormData({ ...formData, trainTimeStart: e.target.value })}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                              åˆ°ç€æ™‚åˆ»
                            </label>
                            <input
                              type="time"
                              value={formData.trainTimeEnd}
                              onChange={(e) => setFormData({ ...formData, trainTimeEnd: e.target.value })}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            />
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            è·¯ç·š
                          </label>
                          <input
                            type="text"
                            value={formData.trainLine}
                            onChange={(e) => setFormData({ ...formData, trainLine: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            placeholder="ä¾‹: å±±æ‰‹ç·š"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            è¡Œãå…ˆ
                          </label>
                          <input
                            type="text"
                            value={formData.trainDestination}
                            onChange={(e) => setFormData({ ...formData, trainDestination: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            placeholder="ä¾‹: æ¸‹è°·æ–¹é¢"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            ä¹—ã‚Šå ´
                          </label>
                          <input
                            type="text"
                            value={formData.trainPlatform}
                            onChange={(e) => setFormData({ ...formData, trainPlatform: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            placeholder="ä¾‹: 3ç•ªç·š"
                          />
                        </div>
                      </>
                    )}

                    {type === 'hotel' && (
                      <>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            ä½æ‰€
                          </label>
                          <input
                            type="text"
                            value={formData.address}
                            onChange={(e) => setFormData({ ...formData, address: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            placeholder="ä¾‹: æ±äº¬éƒ½æ¸‹è°·åŒº..."
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥æ™‚
                          </label>
                          <input
                            type="datetime-local"
                            value={formData.checkOut || getDefaultCheckOut(formData.datetime)}
                            onChange={(e) => setFormData({ ...formData, checkOut: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            âš ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«æœŸæ—¥
                          </label>
                          <input
                            type="datetime-local"
                            value={formData.cancelDeadline || ''}
                            onChange={(e) => setFormData({ ...formData, cancelDeadline: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                          />
                        </div>
                      </>
                    )}

                    {type === 'other' && (
                      <>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            ç›®çš„åœ°
                          </label>
                          <input
                            type="text"
                            value={formData.destination}
                            onChange={(e) => setFormData({ ...formData, destination: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            placeholder="ä¾‹: æ±äº¬ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            ä½æ‰€
                          </label>
                          <input
                            type="text"
                            value={formData.otherAddress}
                            onChange={(e) => setFormData({ ...formData, otherAddress: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            placeholder="ä¾‹: æ±äº¬éƒ½å¢¨ç”°åŒºæŠ¼ä¸Š1-1-2"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">
                            ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ³ã‚¯ï¼ˆURLï¼‰
                          </label>
                          <input
                            type="url"
                            value={formData.customLink}
                            onChange={(e) => setFormData({ ...formData, customLink: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            placeholder="ä¾‹: https://www.example.com"
                          />
                        </div>
                      </>
                    )}

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">
                        ãƒ¡ãƒ¢
                      </label>
                      <textarea
                        value={formData.notes}
                        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                        rows="3"
                        placeholder="æ³¨æ„äº‹é …ã‚„è£œè¶³æƒ…å ±ãªã©"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">
                        äºˆå®šæƒ…å ±ï¼ˆç”»åƒãƒ»PDFï¼‰
                      </label>
                      <input
                        type="file"
                        accept="image/*,.pdf"
                        multiple
                        onChange={handleAttachmentsUpload}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                      />
                      {formData.attachments && formData.attachments.length > 0 && (
                        <div className="mt-2 space-y-2">
                          {formData.attachments.map((file, index) => (
                            <div key={index} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                              <span className="text-sm text-gray-700">{file.name}</span>
                              <button
                                type="button"
                                onClick={() => {
                                  const newAttachments = formData.attachments.filter((_, i) => i !== index);
                                  setFormData({ ...formData, attachments: newAttachments });
                                }}
                                className="text-red-500 hover:text-red-700"
                              >
                                <X size={16} />
                              </button>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>

                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">
                        {uploading && <span className="text-purple-600 animate-pulse ml-2 text-xs">â¬†ï¸ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</span>}
                        é ˜åæ›¸ï¼ˆç”»åƒãƒ»PDFï¼‰
                      </label>
                      <input
                        type="file"
                        accept="image/*,.pdf"
                        multiple
                        onChange={handleReceiptsUpload}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                      />
                      {formData.receipts && formData.receipts.length > 0 && (
                        <div className="mt-2 space-y-2">
                          {formData.receipts.map((file, index) => (
                            <div key={index} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                              <span className="text-sm text-gray-700">{file.name}</span>
                              <button
                                type="button"
                                onClick={() => {
                                  const newReceipts = formData.receipts.filter((_, i) => i !== index);
                                  setFormData({ ...formData, receipts: newReceipts });
                                }}
                                className="text-red-500 hover:text-red-700"
                              >
                                <X size={16} />
                              </button>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>

                    <button
                      type="submit"
                      className="w-full bg-indigo-600 text-white rounded-lg py-3 font-semibold hover:bg-indigo-700 transition"
                    >
                      {item ? 'ä¿å­˜' : 'è¿½åŠ '}
                    </button>
                  </>
                )}
              </form>
            </div>
          </div>
        </div>
      );
    }

    function AIImportModal({ travel, onClose, onImport }) {
      const [mode, setMode] = useState('text'); // 'text' | 'url' | 'file'
      const [url, setUrl] = useState('');
      const [text, setText] = useState('');
      const [file, setFile] = useState(null);
      const [filePreview, setFilePreview] = useState(null); // base64
      const [fileType, setFileType] = useState(''); // 'image' | 'pdf'
      const [loading, setLoading] = useState(false);
      const [previews, setPreviews] = useState([]); // è¤‡æ•°äºˆå®šå¯¾å¿œ
      const [error, setError] = useState('');
      const [apiKeyInput, setApiKeyInput] = useState(window.CLAUDE_API_KEY || '');
      const [showApiKeySetting, setShowApiKeySetting] = useState(
        !window.CLAUDE_API_KEY || window.CLAUDE_API_KEY === 'YOUR_CLAUDE_API_KEY_HERE'
      );

      const SYSTEM_PROMPT = `ã‚ãªãŸã¯æ—…è¡Œäºˆç´„æƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹AIã§ã™ã€‚
æä¾›ã•ã‚ŒãŸæƒ…å ±ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ»ç”»åƒãƒ»PDFï¼‰ã‹ã‚‰æ—…è¡Œã®äºˆå®šã‚’æŠ½å‡ºã—ã€ä»¥ä¸‹ã®JSONé…åˆ—å½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚
è¤‡æ•°ã®äºˆå®šãŒå«ã¾ã‚Œã‚‹å ´åˆï¼ˆä¾‹ï¼šå¾€å¾©ã®é›»è»Šã€è¤‡æ•°åŒºé–“ï¼‰ã¯ã™ã¹ã¦é…åˆ—ã«å«ã‚ã¦ãã ã•ã„ã€‚
ä¸æ˜ãªé …ç›®ã¯nullã«ã—ã¦ãã ã•ã„ã€‚é‡‘é¡ã¯æ•°å€¤ã®ã¿ï¼ˆå††è¨˜å·ãƒ»ã‚«ãƒ³ãƒãªã—ï¼‰ã§è¿”ã—ã¦ãã ã•ã„ã€‚
æ—¥æ™‚ã¯YYYY-MM-DDTHH:MMå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚

typeã¯ä»¥ä¸‹ã‹ã‚‰é¸æŠ:
- "flight": é£›è¡Œæ©Ÿ
- "train": é›»è»Šãƒ»æ–°å¹¹ç·šãƒ»ãƒã‚¹
- "hotel": ãƒ›ãƒ†ãƒ«ãƒ»å®¿æ³Š
- "other": ãã®ä»–

é›»è»Šãƒ»ä¹—ã‚Šæ›ãˆæƒ…å ±ã®å ´åˆ:
{
  "type": "train",
  "title": "å‡ºç™ºé§… â†’ åˆ°ç€é§…",
  "datetime": "å‡ºç™ºæ—¥æ™‚",
  "trainTimeStart": "HH:MM",
  "trainTimeEnd": "HH:MM",
  "trainLine": "è·¯ç·šåãƒ»åˆ—è»Šå",
  "trainDestination": "åˆ°ç€é§…",
  "amount": é‹è³ƒ(æ•°å€¤ã¾ãŸã¯null),
  "notes": "ä¹—ã‚Šæ›ãˆæƒ…å ±ãƒ»åº§å¸­ãªã©",
  "status": "undecided"
}

ãƒ›ãƒ†ãƒ«äºˆç´„ã®å ´åˆ:
{
  "type": "hotel",
  "title": "æ–½è¨­å",
  "datetime": "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ—¥æ™‚",
  "checkOut": "ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥æ™‚",
  "address": "ä½æ‰€",
  "amount": é‡‘é¡(æ•°å€¤),
  "cancelDeadline": "ã‚­ãƒ£ãƒ³ã‚»ãƒ«æœŸæ—¥ã¾ãŸã¯null",
  "notes": "ãƒ—ãƒ©ãƒ³åãƒ»éƒ¨å±‹ã‚¿ã‚¤ãƒ—ãªã©",
  "status": "reserved"
}

é£›è¡Œæ©Ÿã®å ´åˆ:
{
  "type": "flight",
  "title": "å‡ºç™ºç©ºæ¸¯ â†’ åˆ°ç€ç©ºæ¸¯",
  "datetime": "å‡ºç™ºæ—¥æ™‚",
  "airline": "èˆªç©ºä¼šç¤¾å",
  "flightNumber": "ä¾¿å",
  "flightTimeStart": "HH:MM",
  "flightTimeEnd": "HH:MM",
  "amount": é‡‘é¡(æ•°å€¤ã¾ãŸã¯null),
  "notes": "åº§å¸­ãƒ»ã‚¯ãƒ©ã‚¹ãªã©",
  "status": "undecided"
}

JSONã®é…åˆ—ã®ã¿ã‚’è¿”ã—ã€èª¬æ˜æ–‡ãƒ»ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ä¸è¦ã§ã™ã€‚`;

      const handleFileChange = (e) => {
        const f = e.target.files[0];
        if (!f) return;
        setFile(f);
        const isImage = f.type.startsWith('image/');
        const isPDF = f.type === 'application/pdf';
        setFileType(isImage ? 'image' : isPDF ? 'pdf' : '');
        const reader = new FileReader();
        reader.onload = (ev) => setFilePreview(ev.target.result.split(',')[1]);
        reader.readAsDataURL(f);
      };

      const analyze = async () => {
        // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
        if (mode === 'text' && !text.trim()) { setError('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if (mode === 'url' && !url.trim()) { setError('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if (mode === 'file' && !filePreview) { setError('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

        setLoading(true);
        setError('');
        setPreviews([]);

        try {
          let messages;

          if (mode === 'text') {
            messages = [{ role: 'user', content: `ä»¥ä¸‹ã®äºˆç´„ãƒ»ä¹—ã‚Šæ›ãˆæƒ…å ±ã‹ã‚‰æ—…è¡Œäºˆå®šã‚’æŠ½å‡ºã—ã¦ãã ã•ã„:\n\n${text}` }];

          } else if (mode === 'url') {
            const isYahoo = url.includes('transit.yahoo') || url.includes('yahoo.co.jp');
            messages = [{ role: 'user', content: `ä»¥ä¸‹ã®URL${isYahoo ? 'ï¼ˆYahoo!ä¹—ã‚Šæ›ãˆæ¡ˆå†…ï¼‰' : ''}ã®æƒ…å ±ã‹ã‚‰æ—…è¡Œäºˆå®šã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚\nURL: ${url}` }];

          } else if (mode === 'file') {
            // ãƒ•ã‚¡ã‚¤ãƒ«ã®MIMEã‚¿ã‚¤ãƒ—ã‚’æ­£ç¢ºã«åˆ¤å®š
            let mediaType = file.type || 'image/jpeg';
            // image/png, image/jpeg, image/webp, image/gif ã®ã¿APIãŒå—ã‘ä»˜ã‘ã‚‹
            const allowedImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (mediaType === 'application/pdf') {
              // PDFã¯documentãƒ–ãƒ­ãƒƒã‚¯ã§é€ä¿¡
              messages = [{
                role: 'user',
                content: [
                  { type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: filePreview } },
                  { type: 'text', text: 'ã“ã®PDFã‹ã‚‰æ—…è¡Œäºˆå®šï¼ˆãƒ›ãƒ†ãƒ«äºˆç´„ãƒ»èˆªç©ºåˆ¸ãƒ»ä¹—è»Šåˆ¸ãªã©ï¼‰ã®æƒ…å ±ã‚’ã™ã¹ã¦æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚' }
                ]
              }];
            } else {
              // ç”»åƒã¯ image ãƒ–ãƒ­ãƒƒã‚¯ã§é€ä¿¡ï¼ˆæœªå¯¾å¿œã‚¿ã‚¤ãƒ—ã¯jpegã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
              if (!allowedImageTypes.includes(mediaType)) mediaType = 'image/jpeg';
              messages = [{
                role: 'user',
                content: [
                  { type: 'image', source: { type: 'base64', media_type: mediaType, data: filePreview } },
                  { type: 'text', text: 'ã“ã®ç”»åƒã‹ã‚‰æ—…è¡Œäºˆå®šï¼ˆãƒ›ãƒ†ãƒ«äºˆç´„ãƒ»èˆªç©ºåˆ¸ãƒ»ä¹—è»Šåˆ¸ãªã©ï¼‰ã®æƒ…å ±ã‚’ã™ã¹ã¦æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚è¤‡æ•°ä¾¿ã‚ã‚‹å ´åˆã¯ã™ã¹ã¦æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚' }
                ]
              }];
            }
          }

          const apiKey = window.CLAUDE_API_KEY;
          if (!apiKey || apiKey === 'YOUR_CLAUDE_API_KEY_HERE') {
            setShowApiKeySetting(true);
            throw new Error('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
          }

          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-5-20250929',
              max_tokens: 2000,
              system: SYSTEM_PROMPT,
              messages
            })
          });

          if (!response.ok) {
            const errData = await response.json().catch(() => ({}));
            throw new Error(`APIã‚¨ãƒ©ãƒ¼ ${response.status}: ${errData.error?.message || response.statusText}`);
          }

          const data = await response.json();
          if (data.error) throw new Error(data.error.message);

          const raw = data.content?.[0]?.text || '';
          // JSONéƒ¨åˆ†ã ã‘æŠ½å‡ºï¼ˆé…åˆ—ã¾ãŸã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
          const jsonMatch = raw.match(/\[.*\]|\{.*\}/s);
          if (!jsonMatch) throw new Error('AIã®å¿œç­”ã‹ã‚‰JSONã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
          const parsed = JSON.parse(jsonMatch[0]);
          const items = Array.isArray(parsed) ? parsed : [parsed];

          const result = items.map((item, i) => {
            if (!item.datetime) item.datetime = travel.startDate + 'T09:00';
            item.id = Date.now() + i;
            return item;
          });

          setPreviews(result);
        } catch (e) {
          console.error('AIè§£æã‚¨ãƒ©ãƒ¼:', e);
          setError('è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        } finally {
          setLoading(false);
        }
      };

      const typeLabel = { flight: 'é£›è¡Œæ©Ÿ', train: 'é›»è»Š', hotel: 'ãƒ›ãƒ†ãƒ«', other: 'ãã®ä»–' };
      const typeColor = { flight: 'text-blue-600', train: 'text-green-600', hotel: 'text-purple-600', other: 'text-orange-600' };

      const MODES = [
        { id: 'text', label: 'ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆ', desc: 'ãƒšãƒ¼ã‚¸ã®æ–‡ç« ã‚’ã‚³ãƒ”ãƒš' },
        { id: 'url',  label: 'ğŸ”— URL',     desc: 'Yahoo!ä¹—ã‚Šæ›ãˆãªã©' },
        { id: 'file', label: 'ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«', desc: 'PDFãƒ»ç”»åƒã‚’æ·»ä»˜' },
      ];

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold text-gray-800">âœ¨ AIã§è‡ªå‹•å…¥åŠ›</h2>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={24} /></button>
              </div>

              <p className="text-xs text-gray-500 mb-3">ã˜ã‚ƒã‚‰ã‚“ãƒ»æ¥½å¤©ãƒ»JALãƒ»Yahoo!ä¹—ã‚Šæ›ãˆãªã©ã«å¯¾å¿œ</p>

              {/* APIã‚­ãƒ¼è¨­å®š */}
              {showApiKeySetting ? (
                <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-4">
                  <div className="font-semibold text-amber-800 mb-1 text-sm">ğŸ”‘ Claude APIã‚­ãƒ¼ã®è¨­å®šãŒå¿…è¦ã§ã™</div>
                  <p className="text-xs text-amber-700 mb-2">
                    AIè‡ªå‹•å…¥åŠ›ã«ã¯Claude APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚<br/>
                    <a href="https://console.anthropic.com/" target="_blank" className="underline">console.anthropic.com</a> ã§ç„¡æ–™å–å¾—ã§ãã¾ã™ï¼ˆ$5åˆ†ã®ç„¡æ–™æ ã‚ã‚Šï¼‰ã€‚
                  </p>
                  <div className="flex gap-2">
                    <input
                      type="password"
                      value={apiKeyInput}
                      onChange={e => setApiKeyInput(e.target.value)}
                      className="flex-1 px-3 py-2 border border-amber-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-400"
                      placeholder="sk-ant-..."
                    />
                    <button
                      onClick={() => {
                        if (apiKeyInput.startsWith('sk-ant-')) {
                          window.CLAUDE_API_KEY = apiKeyInput;
                          localStorage.setItem('claude_api_key', apiKeyInput);
                          setShowApiKeySetting(false);
                          setError('');
                        } else {
                          setError('APIã‚­ãƒ¼ã¯ sk-ant- ã§å§‹ã¾ã‚‹æ–‡å­—åˆ—ã§ã™');
                        }
                      }}
                      className="bg-amber-600 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-amber-700"
                    >
                      è¨­å®š
                    </button>
                  </div>
                </div>
              ) : (
                <div className="flex items-center justify-between mb-3 text-xs text-green-700 bg-green-50 px-3 py-1.5 rounded-lg">
                  <span>âœ… APIã‚­ãƒ¼è¨­å®šæ¸ˆã¿ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼‰</span>
                  <button onClick={() => {
                    setShowApiKeySetting(true);
                    setApiKeyInput('');
                  }} className="underline text-gray-500">å¤‰æ›´</button>
                </div>
              )}

              {/* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ */}
              <div className="grid grid-cols-3 gap-2 mb-4">
                {MODES.map(m => (
                  <button key={m.id} onClick={() => { setMode(m.id); setError(''); setPreviews([]); }}
                    className={`py-2 px-2 rounded-xl text-sm font-semibold border-2 transition ${mode === m.id ? 'border-purple-500 bg-purple-50 text-purple-700' : 'border-gray-200 text-gray-500 hover:border-gray-300'}`}>
                    <div>{m.label}</div>
                    <div className="text-xs font-normal opacity-70">{m.desc}</div>
                  </button>
                ))}
              </div>

              {/* ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ */}
              {mode === 'text' && (
                <div>
                  <p className="text-sm text-gray-500 mb-2">äºˆç´„ç¢ºèªãƒšãƒ¼ã‚¸ãƒ»ä¹—ã‚Šæ›ãˆæ¡ˆå†…ã®æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</p>
                  <textarea value={text} onChange={e => setText(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                    rows={6}
                    placeholder={"ä¾‹ï¼‰\nãƒ›ãƒ†ãƒ«åï¼šãƒ›ãƒ†ãƒ«æ±æ¨ªã‚¤ãƒ³æ–°å®¿\nãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼š2024å¹´3æœˆ15æ—¥ï¼ˆé‡‘ï¼‰15:00ã€œ\n---ã¾ãŸã¯---\næ±äº¬ 08:30ç™º â†’ æ–°å¤§é˜ª 10:33ç€\nã®ãã¿123å· æŒ‡å®šå¸­ Â¥13,870"}
                  />
                </div>
              )}

              {/* URLãƒ¢ãƒ¼ãƒ‰ */}
              {mode === 'url' && (
                <div>
                  <p className="text-sm text-gray-500 mb-2">Yahoo!ä¹—ã‚Šæ›ãˆãƒ»äºˆç´„ãƒšãƒ¼ã‚¸ã®URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</p>
                  <input type="url" value={url} onChange={e => setUrl(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm"
                    placeholder="https://transit.yahoo.co.jp/..." />
                  <div className="mt-2 text-xs text-amber-700 bg-amber-50 p-2 rounded-lg">
                    âš ï¸ ã˜ã‚ƒã‚‰ã‚“ãƒ»JALç­‰ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªãƒšãƒ¼ã‚¸ã¯URLã®ã¿ã§ã¯èª­ã¿å–ã‚Œã¾ã›ã‚“ã€‚ã€Œãƒ†ã‚­ã‚¹ãƒˆã€ã‹ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
                  </div>
                </div>
              )}

              {/* ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰ */}
              {mode === 'file' && (
                <div>
                  <p className="text-sm text-gray-500 mb-2">äºˆç´„ç¢ºèªã®PDFã‚„ç”»åƒï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼‰ã‚’æ·»ä»˜ã—ã¦ãã ã•ã„</p>
                  <label className={`flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-xl cursor-pointer transition ${filePreview ? 'border-purple-400 bg-purple-50' : 'border-gray-300 hover:border-purple-400 hover:bg-purple-50'}`}>
                    {filePreview ? (
                      <div className="text-center">
                        {fileType === 'image'
                          ? <img src={`data:${file.type};base64,${filePreview}`} className="h-20 mx-auto rounded object-contain" alt="preview" />
                          : <div className="text-4xl mb-1">ğŸ“„</div>
                        }
                        <p className="text-xs text-purple-600 font-semibold mt-1">{file.name}</p>
                      </div>
                    ) : (
                      <div className="text-center text-gray-400">
                        <div className="text-3xl mb-1">ğŸ“</div>
                        <p className="text-sm">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                        <p className="text-xs">PDFãƒ»PNGãƒ»JPGãƒ»WEBPå¯¾å¿œ</p>
                      </div>
                    )}
                    <input type="file" className="hidden" accept=".pdf,.png,.jpg,.jpeg,.webp" onChange={handleFileChange} />
                  </label>
                </div>
              )}

              {error && <p className="text-red-600 text-sm mt-3 bg-red-50 p-2 rounded-lg">{error}</p>}

              <button onClick={analyze} disabled={loading}
                className="w-full mt-4 bg-purple-600 text-white rounded-xl py-3 font-semibold hover:bg-purple-700 transition disabled:opacity-50 flex items-center justify-center gap-2">
                {loading
                  ? <><svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>è§£æä¸­...</>
                  : 'âœ¨ AIè§£æã™ã‚‹'
                }
              </button>

              {/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
              {previews.length > 0 && (
                <div className="mt-4 space-y-3">
                  <div className="font-bold text-purple-700">ğŸ“‹ è§£æçµæœ â€” {previews.length}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</div>
                  {previews.map((p, idx) => (
                    <div key={idx} className="border-2 border-purple-200 rounded-xl p-4 bg-purple-50">
                      <div className={`font-bold mb-2 ${typeColor[p.type] || 'text-gray-700'}`}>
                        {typeLabel[p.type] || p.type}ï¼š{p.title}
                      </div>
                      <div className="space-y-1 text-sm">
                        {p.datetime && <div><span className="text-gray-500">æ—¥æ™‚: </span>{new Date(p.datetime).toLocaleString('ja-JP', {month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div>}
                        {p.checkOut && <div><span className="text-gray-500">ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ: </span>{new Date(p.checkOut).toLocaleString('ja-JP', {month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div>}
                        {p.trainDestination && <div><span className="text-gray-500">åˆ°ç€: </span>{p.trainDestination}</div>}
                        {p.trainLine && <div><span className="text-gray-500">è·¯ç·š: </span>{p.trainLine}</div>}
                        {p.airline && <div><span className="text-gray-500">èˆªç©ºä¼šç¤¾: </span>{p.airline} {p.flightNumber}</div>}
                        {p.amount > 0 && <div><span className="text-gray-500">é‡‘é¡: </span><span className="font-bold text-indigo-600">Â¥{Number(p.amount).toLocaleString()}</span></div>}
                        {p.cancelDeadline && <div><span className="text-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æœŸæ—¥: </span><span className="text-amber-700 font-semibold">{new Date(p.cancelDeadline).toLocaleString('ja-JP', {month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'})}</span></div>}
                        {p.notes && <div><span className="text-gray-500">ãƒ¡ãƒ¢: </span>{p.notes}</div>}
                      </div>
                      <button onClick={() => onImport(p)}
                        className="w-full mt-3 bg-indigo-600 text-white rounded-lg py-2 text-sm font-semibold hover:bg-indigo-700 transition">
                        âœ… ã“ã®äºˆå®šã‚’è¿½åŠ 
                      </button>
                    </div>
                  ))}
                  {previews.length > 1 && (
                    <button onClick={() => { previews.forEach(p => onImport(p)); }}
                      className="w-full bg-gray-700 text-white rounded-xl py-3 font-semibold hover:bg-gray-800 transition">
                      ğŸ“‹ {previews.length}ä»¶ã™ã¹ã¦è¿½åŠ 
                    </button>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    function QRModal({ imageData, onClose }) {
      return (
        <div
          className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50"
          onClick={onClose}
        >
          <div className="max-w-4xl w-full">
            <div className="flex justify-end mb-4">
              <button
                onClick={onClose}
                className="text-white bg-white bg-opacity-20 rounded-full p-2 hover:bg-opacity-30 transition"
              >
                <X size={32} />
              </button>
            </div>
            <img
              src={imageData}
              alt="QR Code"
              className="w-full h-auto bg-white rounded-lg"
              onClick={(e) => e.stopPropagation()}
            />
            <p className="text-white text-center mt-4 text-sm">ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹</p>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
